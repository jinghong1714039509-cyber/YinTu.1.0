{% extends "base_site.html" %}
{% block title %}系统概览{% endblock %}

{% block css %}
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        [v-cloak] { display: none !important; }
    </style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">管理控制台</h1>
            </div>
        </div>
    </div>
</div>

<div class="content" id="dashboard-app" v-cloak>
    <div class="container-fluid">
        
        <div class="row">
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1"><i class="fas fa-microchip"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">服务器 CPU</span>
                        <span class="info-box-number">
                            [[ server.cpu ]]
                            <small>%</small>
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-memory"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">内存使用</span>
                        <span class="info-box-number">[[ server.memory ]] <small>%</small></span>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-success elevation-1"><i class="fas fa-hdd"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">磁盘空间</span>
                        <span class="info-box-number">[[ server.disk ]] <small>%</small></span>
                        <span class="progress-description text-muted" style="font-size: 10px;">
                            [[ server.disk_used_gb ]]G / [[ server.disk_total_gb ]]G
                        </span>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-users"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">当前在线</span>
                        <span class="info-box-number">[[ online.total ]]</span>
                        <span class="progress-description text-muted" style="font-size: 10px;">
                            医: [[ online.doctors ]] | 标: [[ online.labelers ]]
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-8">
                <div class="card card-primary card-outline">
                    <div class="card-header border-0">
                        <div class="d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-chart-line mr-1"></i> 近7日任务新增趋势</h3>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="position-relative mb-4">
                            <div id="trendChart" style="height: 300px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card card-info card-outline">
                    <div class="card-header border-0">
                        <h3 class="card-title"><i class="fas fa-chart-pie mr-1"></i> 任务状态分布</h3>
                    </div>
                    <div class="card-body">
                        <div class="position-relative mb-4">
                            <div id="pieChart" style="height: 300px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header border-0">
                        <h3 class="card-title"><i class="fas fa-trophy text-warning mr-1"></i> 标注员贡献榜 Top 5</h3>
                        <div class="card-tools">
                            <a href="#" class="btn btn-tool btn-sm">
                                <i class="fas fa-sync-alt"></i> 实时更新
                            </a>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-striped table-valign-middle">
                            <thead>
                            <tr>
                                <th>排名</th>
                                <th>用户</th>
                                <th>角色</th>
                                <th class="text-right">标注数量</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="(user, index) in topLabelers" :key="index">
                                <td>
                                    <span v-if="index === 0" class="badge badge-warning">1</span>
                                    <span v-else-if="index === 1" class="badge badge-secondary">2</span>
                                    <span v-else-if="index === 2" class="badge badge-danger">3</span>
                                    <span v-else class="text-muted ml-2">[[ index + 1 ]]</span>
                                </td>
                                <td>
                                    <img src="/static/images/user.png" alt="User" class="img-circle img-size-32 mr-2">
                                    [[ user.name ]]
                                </td>
                                <td><span class="text-muted">[[ user.role ]]</span></td>
                                <td class="text-right">
                                    <span class="text-success text-bold">
                                        <i class="fas fa-caret-up"></i> [[ user.count ]]
                                    </span>
                                </td>
                            </tr>
                            <tr v-if="topLabelers.length === 0">
                                <td colspan="4" class="text-center text-muted py-4">暂无数据</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block js %}
    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // 数据注入 (保持原有的 Django 模板变量)
                const server = ref(JSON.parse('{{ server_stats|safe }}'));
                const online = ref(JSON.parse('{{ online_stats|safe }}'));
                const pieData = JSON.parse('{{ pie_data|safe }}');
                const trendLabels = JSON.parse('{{ trend_labels|safe }}');
                const trendValues = JSON.parse('{{ trend_data|safe }}');
                const topLabelers = ref(JSON.parse('{{ top_labelers|safe }}'));

                let trendChartInst = null;
                let pieChartInst = null;

                const initCharts = () => {
                    // 1. 趋势图
                    const trendDom = document.getElementById('trendChart');
                    if (trendDom) {
                        trendChartInst = echarts.init(trendDom);
                        trendChartInst.setOption({
                            tooltip: { trigger: 'axis' },
                            grid: { top: 30, right: 20, bottom: 20, left: 40, containLabel: true },
                            xAxis: { type: 'category', data: trendLabels, axisLine: { lineStyle: { color: '#ccc' } } },
                            yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#eee' } } },
                            series: [{
                                data: trendValues,
                                type: 'line',
                                smooth: true,
                                itemStyle: { color: '#007bff' },
                                areaStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: 'rgba(0, 123, 255, 0.2)' },
                                        { offset: 1, color: 'rgba(0, 123, 255, 0)' }
                                    ])
                                }
                            }]
                        });
                    }

                    // 2. 饼图
                    const pieDom = document.getElementById('pieChart');
                    if (pieDom) {
                        pieChartInst = echarts.init(pieDom);
                        pieChartInst.setOption({
                            tooltip: { trigger: 'item' },
                            legend: { bottom: '0', left: 'center' },
                            series: [{
                                name: '任务状态',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                                label: { show: false },
                                data: pieData
                            }]
                        });
                    }
                };

                onMounted(() => {
                    setTimeout(() => {
                        initCharts();
                    }, 100);

                    window.addEventListener('resize', () => {
                        trendChartInst && trendChartInst.resize();
                        pieChartInst && pieChartInst.resize();
                    });
                });

                return { server, online, topLabelers };
            }
        }).mount('#dashboard-app');
    </script>
{% endblock %}
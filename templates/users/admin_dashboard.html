{% extends "base_site.html" %}
{% block title %}系统概览{% endblock %}

{% block css %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { corePlugins: { preflight: false } }
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        [v-cloak] { display: none !important; }
    </style>
{% endblock %}

{% block content %}
<div class="right_col" role="main" style="min-height: 100vh;">
    <div id="dashboard-app" v-cloak class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto space-y-6">
            
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 invisible select-none">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2 m-0 border-0">
                        <span class="w-6 h-6"></span>
                        Placeholder
                    </h1>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-medium uppercase">服务器 CPU</p>
                        <p class="text-2xl font-bold text-slate-800 mt-1">[[ server.cpu ]]%</p>
                    </div>
                    <div class="p-3 bg-blue-50 text-blue-600 rounded-lg">
                        <i data-lucide="cpu" class="w-6 h-6"></i>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-medium uppercase">内存使用</p>
                        <p class="text-2xl font-bold text-slate-800 mt-1">[[ server.memory ]]%</p>
                    </div>
                    <div class="p-3 bg-purple-50 text-purple-600 rounded-lg">
                        <i data-lucide="activity" class="w-6 h-6"></i>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-medium uppercase">磁盘空间</p>
                        <p class="text-2xl font-bold text-slate-800 mt-1">[[ server.disk ]]%</p>
                        <p class="text-[10px] text-slate-400">[[ server.disk_used_gb ]]G / [[ server.disk_total_gb ]]G</p>
                    </div>
                    <div class="p-3 bg-orange-50 text-orange-600 rounded-lg">
                        <i data-lucide="hard-drive" class="w-6 h-6"></i>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-medium uppercase">当前在线</p>
                        <p class="text-2xl font-bold text-green-600 mt-1">[[ online.total ]]</p>
                        <p class="text-[10px] text-slate-400">医生: [[ online.doctors ]] | 标注: [[ online.labelers ]]</p>
                    </div>
                    <div class="p-3 bg-green-50 text-green-600 rounded-lg">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-500"></i> 近7日任务新增趋势
                    </h3>
                    <div id="trendChart" style="height: 300px; width: 100%;"></div>
                </div>

                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-4 h-4 text-indigo-500"></i> 任务状态分布
                    </h3>
                    <div id="pieChart" style="height: 300px; width: 100%;"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-base font-bold text-slate-800 flex items-center gap-2 m-0">
                        <i data-lucide="award" class="w-4 h-4 text-yellow-500"></i> 标注员贡献榜 Top 5
                    </h3>
                    <span class="text-xs text-slate-400">实时更新</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-semibold">
                            <tr>
                                <th class="px-6 py-3">排名</th>
                                <th class="px-6 py-3">用户</th>
                                <th class="px-6 py-3">角色</th>
                                <th class="px-6 py-3 text-right">标注数量</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(user, index) in topLabelers" :key="index" class="hover:bg-slate-50/50">
                                <td class="px-6 py-3">
                                    <span v-if="index === 0" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-yellow-100 text-yellow-700 text-xs font-bold">1</span>
                                    <span v-else-if="index === 1" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-700 text-xs font-bold">2</span>
                                    <span v-else-if="index === 2" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-orange-100 text-orange-700 text-xs font-bold">3</span>
                                    <span v-else class="text-slate-500 pl-2 text-sm">[[ index + 1 ]]</span>
                                </td>
                                <td class="px-6 py-3 font-medium text-slate-700">[[ user.name ]]</td>
                                <td class="px-6 py-3 text-sm text-slate-500">[[ user.role ]]</td>
                                <td class="px-6 py-3 text-right font-bold text-indigo-600">[[ user.count ]]</td>
                            </tr>
                            <tr v-if="topLabelers.length === 0">
                                <td colspan="4" class="px-6 py-8 text-center text-slate-400 text-sm">暂无标注数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block js %}
    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // 后端数据注入
                const server = ref(JSON.parse('{{ server_stats|safe }}'));
                const online = ref(JSON.parse('{{ online_stats|safe }}'));
                const pieData = JSON.parse('{{ pie_data|safe }}');
                const trendLabels = JSON.parse('{{ trend_labels|safe }}');
                const trendValues = JSON.parse('{{ trend_data|safe }}');
                const topLabelers = ref(JSON.parse('{{ top_labelers|safe }}'));

                let trendChartInst = null;
                let pieChartInst = null;

                const initCharts = () => {
                    // 1. 趋势图
                    const trendDom = document.getElementById('trendChart');
                    if (trendDom) {
                        trendChartInst = echarts.init(trendDom);
                        trendChartInst.setOption({
                            tooltip: { trigger: 'axis' },
                            grid: { top: 20, right: 20, bottom: 20, left: 40, containLabel: true },
                            xAxis: { type: 'category', data: trendLabels, axisLine: { lineStyle: { color: '#e2e8f0' } } },
                            yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#f1f5f9' } } },
                            series: [{
                                data: trendValues,
                                type: 'line',
                                smooth: true,
                                itemStyle: { color: '#3b82f6' },
                                areaStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: 'rgba(59, 130, 246, 0.2)' },
                                        { offset: 1, color: 'rgba(59, 130, 246, 0)' }
                                    ])
                                }
                            }]
                        });
                    }

                    // 2. 饼图
                    const pieDom = document.getElementById('pieChart');
                    if (pieDom) {
                        pieChartInst = echarts.init(pieDom);
                        pieChartInst.setOption({
                            tooltip: { trigger: 'item' },
                            legend: { bottom: '0', left: 'center', itemWidth: 10, itemHeight: 10 },
                            color: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#94a3b8'],
                            series: [{
                                name: '任务状态',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                                label: { show: false },
                                data: pieData
                            }]
                        });
                    }
                };

                onMounted(() => {
                    setTimeout(() => {
                        if (window.lucide) window.lucide.createIcons();
                        initCharts();
                    }, 100);

                    window.addEventListener('resize', () => {
                        trendChartInst && trendChartInst.resize();
                        pieChartInst && pieChartInst.resize();
                    });
                });

                return { server, online, topLabelers };
            }
        }).mount('#dashboard-app');
    </script>
{% endblock %}
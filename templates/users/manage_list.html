{% extends "base_site.html" %}
{% load static %}

{% block title %}用户与权限管理{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    /* Vue 动画过渡 */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    /* 在线呼吸灯动画 */
    .pulse-dot { animation: pulse-green 2s infinite; }
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
        70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    /* 简单的样式隔离，防止 Tailwind 样式污染全局导航栏 */
    #app-container button { outline: none; }
</style>

<div id="app" class="right_col" role="main">
    <div id="app-container" class="min-h-screen p-6">
        
        <div class="max-w-7xl mx-auto mb-6 space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                        <i data-lucide="layout-dashboard" class="w-6 h-6 text-blue-600"></i>
                        用户账户管理 <small class="text-sm font-normal text-gray-500">超级管理员后台</small>
                    </h1>
                </div>
                <div class="flex gap-4 text-sm">
                    <div class="bg-white px-4 py-2 rounded-lg border shadow-sm flex items-center gap-2">
                        <span class="text-gray-500">总用户</span>
                        <span class="font-bold text-lg">[[ users.length ]]</span>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-lg border shadow-sm flex items-center gap-2 border-green-200 bg-green-50">
                        <span class="text-green-700 flex items-center gap-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            活跃用户
                        </span>
                        <span class="font-bold text-lg text-green-700">[[ activeCount ]]</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between gap-3 bg-white p-3 rounded-xl border shadow-sm">
                <div class="flex gap-3 w-full sm:w-auto items-center">
                    <div class="relative flex-1 sm:flex-none">
                        <i data-lucide="search" class="absolute left-3 top-2.5 h-4 w-4 text-gray-400"></i>
                        <input 
                            v-model="searchQuery"
                            type="text" 
                            placeholder="搜索姓名、邮箱或ID..." 
                            class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-64 bg-gray-50 focus:bg-white transition"
                        />
                    </div>
                    
                    <label class="flex items-center gap-2 cursor-pointer select-none px-3 py-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-200 transition">
                        <div class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="onlyActive" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-600">只看启用</span>
                    </label>
                </div>

                <a href="{% url 'users:register' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm font-medium no-underline hover:text-white">
                    <i data-lucide="user-plus" class="w-4 h-4"></i> 新增用户
                </a>
            </div>
        </div>

        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-semibold tracking-wider">
                        <tr>
                            <th class="px-6 py-4 border-b">用户 / 状态</th>
                            <th class="px-6 py-4 border-b">角色 & 部门</th>
                            <th class="px-6 py-4 border-b">联系方式</th>
                            <th class="px-6 py-4 border-b">最后活跃/注册时间</th>
                            <th class="px-6 py-4 border-b text-right">管理操作</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-for="user in filteredUsers" :key="user.id" class="hover:bg-blue-50/50 transition duration-150">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <div class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-500 font-bold text-sm">
                                            [[ user.name.charAt(0).toUpperCase() ]]
                                        </div>
                                        <span 
                                            v-if="user.isActive"
                                            class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-green-500" 
                                            title="已启用">
                                        </span>
                                        <span 
                                            v-else
                                            class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-gray-300"
                                            title="已禁用">
                                        </span>
                                    </div>
                                    
                                    <div>
                                        <div class="font-medium text-slate-900 flex items-center gap-2">
                                            [[ user.name ]]
                                            <span v-if="user.isSuperuser" class="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-medium">超级管理员</span>
                                        </div>
                                        <div class="text-sm text-gray-500">ID: [[ user.id ]]</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col items-start gap-1">
                                    <span :class="roleBadgeClass(user.roleCode)" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border">
                                        [[ user.roleName ]]
                                    </span>
                                    <small v-if="user.department" class="text-gray-500 text-xs">[[ user.department ]]</small>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-700">[[ user.email ]]</div>
                                <div class="text-xs text-gray-400">[[ user.phone ]]</div>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <div class="text-gray-700">[[ user.lastActive ]]</div>
                                <div class="text-xs text-gray-400">注册: [[ user.dateJoined ]]</div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2" v-if="!user.isSuperuser">
                                    <button @click="openPwdModal(user)" class="text-gray-600 hover:text-orange-600 hover:bg-orange-50 border border-gray-300 hover:border-orange-300 px-3 py-1.5 rounded text-xs font-medium transition flex items-center gap-1">
                                        <i data-lucide="key" class="w-3 h-3"></i> 重置密码
                                    </button>
                                    
                                    <a :href="user.deleteUrl" onclick="return confirm('⛔ 高危操作\n确定要永久删除此用户吗？此操作不可恢复！')" class="text-gray-600 hover:text-red-600 hover:bg-red-50 border border-gray-300 hover:border-red-300 px-3 py-1.5 rounded text-xs font-medium transition flex items-center gap-1 no-underline">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i> 删除
                                    </a>
                                </div>
                                <div v-else class="text-gray-400 text-xs text-right">
                                    <span class="flex items-center justify-end gap-1"><i data-lucide="shield" class="w-3 h-3"></i> 系统保护</span>
                                </div>
                            </td>
                        </tr>
                        <tr v-if="filteredUsers.length === 0">
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500 bg-gray-50/50">
                                <div class="flex flex-col items-center justify-center gap-2">
                                    <i data-lucide="search-x" class="w-8 h-8 text-gray-300"></i>
                                    <p>没有找到符合条件的用户</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <transition name="fade">
            <div v-if="showPwdModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeModals"></div>
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden border-t-4 border-orange-500">
                    <div class="bg-white px-6 py-4 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="key-round" class="w-5 h-5 text-orange-500"></i> 重置密码
                        </h3>
                        <button @click="closeModals" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-6 space-y-4">
                        <p class="text-sm text-gray-500 bg-orange-50 p-3 rounded border border-orange-100">
                            正在为用户 <strong>[[ currentUser?.name ]]</strong> 重置密码。
                        </p>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">新密码将设置为</label>
                            <input type="text" value="123456" readonly class="w-full border border-gray-300 p-2.5 rounded-lg bg-gray-50 text-center font-mono text-lg tracking-widest text-slate-700 select-all">
                        </div>
                        <div class="text-xs text-gray-400">
                            * 重置后请通知用户尽快修改密码。
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                        <button @click="closeModals" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm font-medium transition">取消</button>
                        <a :href="currentUser?.resetUrl" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm font-medium transition no-underline flex items-center">
                            确认重置
                        </a>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="toastMsg" class="fixed top-6 right-6 z-[60] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                [[ toastMsg ]]
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, onUpdated } = Vue;

    createApp({
        delimiters: ['[[', ']]'], 
        setup() {
            // 将 Django 模板数据注入 Vue
            const users = ref([
                {% for u in users %}
                { 
                    id: "{{ u.id }}", 
                    name: "{{ u.username|escapejs }}", 
                    email: "{{ u.email|default:'-'|escapejs }}", 
                    roleCode: "{{ u.role }}",
                    // 角色中文显示逻辑
                    roleName: "{% if u.is_superuser %}管理员{% elif u.role == 'hospital' %}医生{% elif u.role == 'labeler' %}标注员{% else %}未知{% endif %}",
                    department: "{{ u.department|default:''|escapejs }}",
                    phone: "{{ u.phone|default:'-'|escapejs }}",
                    isActive: {{ u.is_active|yesno:"true,false" }},
                    isSuperuser: {{ u.is_superuser|yesno:"true,false" }},
                    // 时间显示
                    dateJoined: "{{ u.date_joined|date:'Y-m-d' }}",
                    lastActive: "{{ u.last_login|date:'Y-m-d H:i'|default:'从未登录' }}",
                    // 操作链接
                    resetUrl: "{% url 'users:user_reset' u.id %}",
                    deleteUrl: "{% url 'users:user_delete' u.id %}"
                },
                {% endfor %}
            ]);

            const searchQuery = ref('');
            const onlyActive = ref(false);
            const showPwdModal = ref(false);
            const currentUser = ref(null);
            const toastMsg = ref('');

            // 统计活跃人数
            const activeCount = computed(() => {
                return users.value.filter(u => u.isActive).length;
            });

            // 过滤逻辑
            const filteredUsers = computed(() => {
                return users.value.filter(user => {
                    const search = searchQuery.value.toLowerCase();
                    const matchesSearch = user.name.toLowerCase().includes(search) || 
                                          user.email.toLowerCase().includes(search) ||
                                          user.id.toString().includes(search);
                    
                    const matchesStatus = onlyActive.value ? user.isActive : true;

                    return matchesSearch && matchesStatus;
                });
            });

            const roleBadgeClass = (roleCode) => {
                if (roleCode === 'hospital') return 'bg-blue-50 text-blue-700 border-blue-200'; // 医生蓝色
                if (roleCode === 'labeler') return 'bg-green-50 text-green-700 border-green-200'; // 标注员绿色
                return 'bg-gray-100 text-gray-700 border-gray-200';
            };

            const openPwdModal = (user) => {
                currentUser.value = user;
                showPwdModal.value = true;
            };

            const closeModals = () => {
                showPwdModal.value = false;
            };

            const refreshIcons = () => {
                setTimeout(() => {
                    if (window.lucide) window.lucide.createIcons();
                }, 0);
            };

            onMounted(refreshIcons);
            onUpdated(refreshIcons);

            return {
                users,
                searchQuery,
                onlyActive,
                activeCount,
                filteredUsers,
                showPwdModal,
                currentUser,
                toastMsg,
                roleBadgeClass,
                openPwdModal,
                closeModals
            };
        }
    }).mount('#app');
</script>
{% endblock %}
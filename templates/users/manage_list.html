{% extends "base_site.html" %}
{% load static %}

{% block title %}用户与权限管理{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    /* ✅ 新增：绿色呼吸灯动画 */
    .pulse-dot { animation: pulse-green 2s infinite; }
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
        70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    #app-container button { outline: none; }
</style>

<div id="app" class="right_col" role="main">
    <div id="app-container" class="min-h-screen p-6">
        
        <div class="max-w-7xl mx-auto mb-6 space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                        <i data-lucide="layout-dashboard" class="w-6 h-6 text-blue-600"></i>
                        用户账户管理 <small class="text-sm font-normal text-gray-500">超级管理员后台</small>
                    </h1>
                </div>
                <div class="flex gap-4 text-sm">
                    <div class="bg-white px-4 py-2 rounded-lg border shadow-sm flex items-center gap-2">
                        <span class="text-gray-500">总用户</span>
                        <span class="font-bold text-lg">[[ users.length ]]</span>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-lg border shadow-sm flex items-center gap-2 border-green-200 bg-green-50">
                        <span class="text-green-700 flex items-center gap-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            当前在线
                        </span>
                        <span class="font-bold text-lg text-green-700">[[ activeCount ]]</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between gap-3 bg-white p-3 rounded-xl border shadow-sm">
                <div class="flex gap-3 w-full sm:w-auto items-center">
                    <div class="relative flex-1 sm:flex-none">
                        <i data-lucide="search" class="absolute left-3 top-2.5 h-4 w-4 text-gray-400"></i>
                        <input v-model="searchQuery" type="text" placeholder="搜索姓名、邮箱或ID..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-64 bg-gray-50 focus:bg-white transition" />
                    </div>
                    <a href="{% url 'users:register' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm font-medium no-underline hover:text-white">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> 新增用户
                    </a>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-semibold tracking-wider">
                        <tr>
                            <th class="px-6 py-4 border-b">用户 / 在线状态</th>
                            <th class="px-6 py-4 border-b">角色 & 部门</th>
                            <th class="px-6 py-4 border-b">联系方式</th>
                            <th class="px-6 py-4 border-b">最后活跃/注册时间</th>
                            <th class="px-6 py-4 border-b text-right">管理操作</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-for="user in filteredUsers" :key="user.id" class="hover:bg-blue-50/50 transition duration-150">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <div class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-500 font-bold text-sm">
                                            [[ user.name.charAt(0).toUpperCase() ]]
                                        </div>
                                        
                                        <span 
                                            v-if="user.isOnline"
                                            class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-green-500 pulse-dot" 
                                            title="实时在线">
                                        </span>
                                        <span 
                                            v-else
                                            class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-gray-300"
                                            title="离线">
                                        </span>
                                        
                                    </div>
                                    
                                    <div>
                                        <div class="font-medium text-slate-900 flex items-center gap-2">
                                            [[ user.name ]]
                                            <span v-if="!user.isActive" class="text-[10px] bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded font-medium">已封禁</span>
                                            <span v-if="user.isSuperuser" class="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-medium">超级管理员</span>
                                        </div>
                                        <div class="text-sm text-gray-500">ID: [[ user.id ]]</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">[[ user.roleName ]] <small class="text-gray-500">[[ user.department ]]</small></td>
                            <td class="px-6 py-4"><div class="text-sm">[[ user.email ]]</div><div class="text-xs text-gray-400">[[ user.phone ]]</div></td>
                            <td class="px-6 py-4 text-sm">[[ user.lastActive ]]</td>
                            
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2" v-if="!user.isSuperuser">
                                    <button @click="openPwdModal(user)" class="text-gray-600 hover:text-orange-600 border border-gray-300 px-3 py-1.5 rounded text-xs font-medium transition">重置密码</button>
                                    <a :href="user.deleteUrl" onclick="return confirm('确定删除？')" class="text-gray-600 hover:text-red-600 border border-gray-300 px-3 py-1.5 rounded text-xs font-medium transition no-underline">删除</a>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <transition name="fade"><div v-if="showPwdModal">...</div></transition>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, onUpdated } = Vue;

    createApp({
        delimiters: ['[[', ']]'], 
        setup() {
            const users = ref([
                {% for u in users %}
                { 
                    id: "{{ u.id }}", 
                    name: "{{ u.username|escapejs }}", 
                    email: "{{ u.email|default:'-'|escapejs }}", 
                    roleName: "{% if u.is_superuser %}管理员{% elif u.role == 'hospital' %}医生{% else %}标注员{% endif %}",
                    department: "{{ u.department|default:''|escapejs }}",
                    phone: "{{ u.phone|default:'-'|escapejs }}",
                    
                    // ✅ 核心修改：接收后端传来的实时在线状态
                    isOnline: {{ u.is_online_real|yesno:"true,false" }}, 
                    
                    isActive: {{ u.is_active|yesno:"true,false" }},
                    isSuperuser: {{ u.is_superuser|yesno:"true,false" }},
                    dateJoined: "{{ u.date_joined|date:'Y-m-d' }}",
                    lastActive: "{{ u.last_login|date:'Y-m-d H:i'|default:'从未登录' }}",
                    resetUrl: "{% url 'users:user_reset' u.id %}",
                    deleteUrl: "{% url 'users:user_delete' u.id %}"
                },
                {% endfor %}
            ]);

            const searchQuery = ref('');
            const activeCount = computed(() => {
                // ✅ 修改：只统计真正的在线用户
                return users.value.filter(u => u.isOnline).length;
            });

            // 过滤逻辑保持不变
            const filteredUsers = computed(() => {
                return users.value.filter(user => {
                    const search = searchQuery.value.toLowerCase();
                    return user.name.toLowerCase().includes(search) || user.email.toLowerCase().includes(search);
                });
            });

            // ... 其他函数保持不变 ...
            const openPwdModal = (user) => { /* ... */ };
            const closeModals = () => { /* ... */ };
            const refreshIcons = () => { setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 0); };

            onMounted(refreshIcons);
            onUpdated(refreshIcons);

            return {
                users, searchQuery, activeCount, filteredUsers, // ...
                // 记得把用到的变量都 return 出去
            };
        }
    }).mount('#app');
</script>
{% endblock %}
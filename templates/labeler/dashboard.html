{% extends "base_site.html" %}
{% block title %}任务大厅 | 标注工作台{% endblock %}

{% block css %}
<style>
    /* 统计概览卡片样式 */
    .overview-card {
        background: #fff; border-radius: 12px; border: 1px solid #f3f4f6;
        padding: 20px; display: flex; align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .overview-icon {
        width: 48px; height: 48px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; margin-right: 16px;
    }
    .overview-val { font-size: 24px; font-weight: 700; line-height: 1.2; color: #1f2937; }
    .overview-label { font-size: 13px; color: #6b7280; }

    /* 任务卡片样式 */
    .task-card {
        background: #fff; border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04); border: 1px solid #f3f4f6;
        transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column;
        overflow: hidden;
    }
    .task-card:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -8px rgba(0,0,0,0.1); border-color: #e5e7eb; }
    
    .status-bar { height: 4px; width: 100%; }
    .card-content { padding: 20px; flex: 1; }
    .task-title {
        font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 8px;
        display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
    }
    .task-info { font-size: 13px; color: #6b7280; margin-bottom: 16px; display: flex; justify-content: space-between; }
    
    .stats-grid {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
        background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 16px;
    }
    .stat-box { text-align: center; }
    .stat-val { font-size: 16px; font-weight: 700; display: block; line-height: 1.2; }
    .stat-key { font-size: 11px; color: #9ca3af; text-transform: uppercase; }

    .card-actions {
        padding: 12px 20px; border-top: 1px solid #f3f4f6; background: #fafafa;
        display: flex; gap: 8px; 
    }
    .btn-action { font-size: 13px; padding: 8px 0; border-radius: 6px; font-weight: 500; flex: 1; }
    .btn-action:first-child { flex: 2; }
</style>
{% endblock %}

{% block content %}
<section class="content-header">
    <div class="container-fluid">
        <div class="mb-4">
            <h1 class="font-weight-bold text-dark" style="font-size: 24px;">我的标注任务</h1>
            <p class="text-muted small mb-0">查看分配给您的任务，点击“开始标注”进入工作台。</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-3 col-6 mb-3 mb-md-0">
                <div class="overview-card">
                    <div class="overview-icon bg-light text-dark"><i class="fas fa-layer-group"></i></div>
                    <div><div class="overview-val">{{ stats.total }}</div><div class="overview-label">任务总数</div></div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3 mb-md-0">
                <div class="overview-card">
                    <div class="overview-icon" style="background: #f3f4f6; color: #6b7280;"><i class="far fa-pause-circle"></i></div>
                    <div><div class="overview-val">{{ stats.not_started }}</div><div class="overview-label">未开始</div></div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="overview-card">
                    <div class="overview-icon" style="background: #e0f2fe; color: #0284c7;"><i class="fas fa-spinner"></i></div>
                    <div><div class="overview-val">{{ stats.in_progress }}</div><div class="overview-label">进行中</div></div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="overview-card">
                    <div class="overview-icon" style="background: #dcfce7; color: #16a34a;"><i class="fas fa-check"></i></div>
                    <div><div class="overview-val">{{ stats.completed }}</div><div class="overview-label">已完成</div></div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            {% for task in tasks %}
            <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-4">
                <div class="task-card">
                    <div class="status-bar" 
                         style="background: {% if task.status_tag == 'done' %}#10b981{% elif task.status_tag == 'processing' %}#3b82f6{% else %}#9ca3af{% endif %};">
                    </div>
                    
                    <div class="card-content">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge badge-light border text-muted">#{{ task.code|slice:"-6:" }}</span>
                            
                            {% if task.status_tag == 'done' %}
                                <span class="badge badge-success-light text-success bg-green-light">已完成</span>
                            {% elif task.status_tag == 'not_started' %}
                                <span class="badge badge-secondary text-secondary" style="background:#f3f4f6;">未开始</span>
                            {% else %}
                                <span class="badge badge-primary-light text-primary bg-blue-light">进行中</span>
                            {% endif %}
                        </div>

                        <h5 class="task-title" title="{{ task.name }}">{{ task.name }}</h5>
                        <div class="task-info">
                            <span><i class="far fa-user mr-1"></i>{{ task.creator.username }}</span>
                            <span>{{ task.created_at|date:"m-d" }}</span>
                        </div>

                        <div class="d-flex justify-content-between text-xs mb-1">
                            <span class="text-muted">完成度</span>
                            <span class="font-weight-bold text-primary">{{ task.progress }}%</span>
                        </div>
                        <div class="progress rounded-pill mb-3" style="height: 6px; background-color: #f3f4f6;">
                            <div class="progress-bar" 
                                 style="width: {{ task.progress }}%; background-color: {% if task.progress == 0 %}#9ca3af{% elif task.progress == 100 %}#10b981{% else %}#3b82f6{% endif %};">
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-box border-right">
                                <span class="stat-val text-dark">{{ task.sample_count }}</span>
                                <span class="stat-key">总量</span>
                            </div>
                            <div class="stat-box border-right">
                                <span class="stat-val text-success">{{ task.labeled_count }}</span>
                                <span class="stat-key">已标</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-val {% if task.labeled_count == 0 %}text-muted{% else %}text-danger{% endif %}">
                                    {{ task.sample_count|add:"-"|add:task.labeled_count }}
                                </span>
                                <span class="stat-key">剩余</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-actions">
                        {% if task.first_sample_id %}
                            <a href="{% url 'labeler:annotate' task.first_sample_id %}" class="btn btn-primary btn-action shadow-sm">
                                {% if task.labeled_count == 0 %}
                                    <i class="fas fa-play mr-1"></i> 开始标注
                                {% else %}
                                    <i class="fas fa-pen-nib mr-1"></i> 继续标注
                                {% endif %}
                            </a>
                        {% else %}
                            <button class="btn btn-secondary btn-action" disabled>空任务</button>
                        {% endif %}

                        <a href="{% url 'labeler:gallery' task.id %}" class="btn btn-outline-secondary btn-action" title="查看图片库">
                            <i class="far fa-images"></i>
                        </a>
                        
                        <button type="button" class="btn btn-outline-warning btn-action" onclick="openUploadModal('{{ task.id }}', '{{ task.name }}')" title="上传离线结果">
                            <i class="fas fa-upload"></i>
                        </button>
                        
                        {% if user.is_superuser %}
                        <a href="{% url 'labeler:delete_task' task.id %}" 
                           class="btn btn-outline-danger btn-action" 
                           onclick="return confirm('⚠️ 高危操作：\n确定要永久删除任务【{{ task.name }}】吗？')" 
                           title="删除">
                            <i class="fas fa-trash"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="text-center py-5 bg-white rounded shadow-sm border">
                    <img src="https://cdn-icons-png.flaticon.com/512/4076/4076432.png" alt="Empty" style="width: 100px; opacity: 0.5;" class="mb-3">
                    <h5 class="text-muted">暂无待办任务</h5>
                    <p class="text-secondary small">当前没有分配给您的标注任务。</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title font-weight-bold">上传标注数据包</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted small mb-3">目标任务：<span id="modalTaskName" class="text-primary font-weight-bold"></span></p>
                    <div class="alert alert-warning border-0 small" style="background: #fffbeb; color: #92400e;">
                        <i class="fas fa-info-circle mr-1"></i> 请上传包含 XML/JSON 文件的 ZIP 压缩包，文件名需与图片一致。
                    </div>
                    
                    <div class="custom-file mt-2">
                        <input type="file" class="custom-file-input" name="annotation_file" id="annoFile" required accept=".zip">
                        <label class="custom-file-label rounded-lg" for="annoFile">点击选择 ZIP 文件...</label>
                    </div>
                </div>
                <div class="modal-footer border-top-0 pt-0">
                    <button type="button" class="btn btn-light rounded-lg" data-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary rounded-lg px-4">确认上传</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/bs-custom-file-input/dist/bs-custom-file-input.min.js"></script>
<script>
    $(function () {
        bsCustomFileInput.init();
    });

    function openUploadModal(taskId, taskName) {
        $('#modalTaskName').text(taskName);
        var uploadUrl = "{% url 'labeler:upload' 0 %}".replace('0', taskId);
        $('#uploadForm').attr('action', uploadUrl);
        $('#uploadModal').modal('show');
    }
</script>
{% endblock %}
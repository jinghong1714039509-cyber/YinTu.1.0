{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YinTu 标注工作台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <style>
        /* --- 全局暗色主题 --- */
        body { 
            background-color: #1e1e1e; 
            color: #dcdcdc; 
            font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
            user-select: none; 
        }

        /* --- 布局结构 --- */
        .workspace { 
            display: flex; 
            flex-direction: column; /* 改为垂直布局，以便放顶部栏 */
            height: 100%; 
            width: 100%;
        }

        /* ✅ [修改2] 新增：顶部信息栏 (仿 X-AnyLabeling) */
        .top-bar {
            height: 30px;
            background-color: #333;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 12px;
            color: #ccc;
            z-index: 50;
        }
        
        .top-bar-left, .top-bar-center, .top-bar-right {
            display: flex; align-items: center; gap: 15px;
        }
        
        .shortcut-hint { color: #888; }
        .filename { font-weight: bold; color: #fff; }

        /* 状态指示灯 */
        .status-indicator { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .status-saved .status-dot { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-saving .status-dot { background: #f1c40f; }
        .status-unsaved .status-dot { background: #e74c3c; }

        /* --- 主工作区 (包含左侧、画布、右侧) --- */
        .main-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* --- 左侧工具栏 --- */
        .left-toolbar {
            width: 50px;
            background-color: #252526;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            z-index: 40;
        }

        .tool-btn {
            width: 36px; height: 36px; margin-bottom: 8px;
            border-radius: 4px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            color: #858585; transition: all 0.2s; position: relative;
        }
        .tool-btn:hover { background-color: #3e3e42; color: #fff; }
        .tool-btn.active { background-color: #0e639c; color: #fff; }

        /* --- 中间画布 --- */
        .canvas-container { 
            flex: 1; 
            background: #1e1e1e; 
            position: relative; 
            overflow: auto; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        .img-wrapper { 
            position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            display: none; /* 初始隐藏 */
        }
        
        #target-image { display: block; }
        #annotation-layer { position: absolute; top: 0; left: 0; z-index: 10; }

        /* --- 右侧列表 --- */
        .sidebar { 
            width: 280px; 
            background: #252526; 
            border-left: 1px solid #333; 
            display: flex; flex-direction: column; 
            z-index: 20; 
        }
        .sidebar-header { 
            padding: 8px 15px; background: #2d2d2d; 
            border-bottom: 1px solid #333; font-weight: bold; font-size: 12px; 
        }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        .sidebar-footer { padding: 10px; background: #2d2d2d; border-top: 1px solid #333; }

        .anno-item { 
            background: #333; padding: 6px 10px; margin-bottom: 4px; 
            font-size: 12px; border-radius: 2px; 
            border-left: 3px solid #ccc; cursor: pointer;
            display: flex; justify-content: space-between;
        }
        .anno-item:hover { background: #3e3e42; }

        /* --- 弹窗与加载 --- */
        #label-modal { 
            position: absolute; display: none; 
            background: #252526; padding: 10px; 
            border: 1px solid #444; border-radius: 4px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
            z-index: 9999; width: 220px; 
        }
        
        #loading-overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: #1e1e1e; z-index: 10000; 
            display: flex; justify-content: center; align-items: center; 
        }
        .spinner { 
            width: 30px; height: 30px; 
            border: 3px solid #333; border-top: 3px solid #0e639c; 
            border-radius: 50%; animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div></div>

    <div class="workspace">
        
        <div class="top-bar">
            <div class="top-bar-left">
                <i class="fa fa-picture-o"></i>
                <span class="filename" id="img-name-display">Loading...</span>
            </div>
            
            <div class="top-bar-center">
                <span class="shortcut-hint">快捷键: 上一张(A) 下一张(D) 矩形(R) 多边形(P) 撤销(Ctrl+Z) 保存(Ctrl+S)</span>
            </div>
            
            <div class="top-bar-right">
                <select id="lang-switch" style="background:#444; border:none; color:#ccc; font-size:11px; height:20px;">
                    <option value="cn">中文</option>
                    <option value="en">English</option>
                </select>
                <div class="status-indicator status-saved" id="save-status">
                    <div class="status-dot"></div>
                    <span id="save-text">已保存</span>
                </div>
            </div>
        </div>

        <div class="main-area">
            <div class="left-toolbar">
                <div class="tool-btn active" id="tool-select" onclick="switchTool('select')" title="选择 (V)">
                    <i class="fa fa-mouse-pointer"></i>
                </div>
                <div class="tool-btn" id="tool-rect" onclick="switchTool('rect')" title="矩形 (R)">
                    <i class="fa fa-square-o"></i>
                </div>
                <div class="tool-btn" id="tool-polygon" onclick="switchTool('polygon')" title="多边形 (P)">
                    <i class="fa fa-pencil"></i>
                </div>
                <div style="flex:1"></div>
                <div class="tool-btn" onclick="undoPoint()" title="撤销点 (Ctrl+Z)">
                    <i class="fa fa-undo"></i>
                </div>
                <a href="{% url 'labeler:dashboard' %}" class="tool-btn" title="退出">
                    <i class="fa fa-sign-out"></i>
                </a>
            </div>

            <div class="canvas-container">
                <div class="img-wrapper" id="img-wrapper">
                    <img id="target-image" draggable="false">
                    <canvas id="annotation-layer"></canvas>
                </div>

                <div id="label-modal">
                    <div style="color:#bbb; font-size:12px; margin-bottom:5px;">选择标签 (Select Label)</div>
                    <select id="label-select" class="form-control input-sm" style="background:#3e3e42; color:#fff; border:1px solid #555; margin-bottom:10px;">
                        {% for item in label_config %}
                        <option value="{{ item.code }}">{{ item.name_cn }}</option>
                        {% empty %}
                        <option value="nodule">默认 (Default)</option>
                        {% endfor %}
                    </select>
                    <div class="text-right">
                        <button class="btn btn-xs btn-default" style="background:transparent; color:#ccc; border:none;" onclick="dismissModal()">取消</button>
                        <button class="btn btn-xs btn-primary" onclick="confirmShape()">确定 (Enter)</button>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-header">标注列表 (Objects)</div>
                <div class="sidebar-content" id="list-container"></div>
                <div class="sidebar-footer">
                    <div class="btn-group btn-group-justified">
                        <div class="btn-group">
                            <button id="btn-prev" class="btn btn-default btn-sm" onclick="loadSample(currentSample.prevId)" disabled>
                               <i class="fa fa-chevron-left"></i> 上一张
                            </button>
                        </div>
                        <div class="btn-group">
                            <button id="btn-next" class="btn btn-primary btn-sm" onclick="loadSample(currentSample.nextId)" disabled>
                               下一张 <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{ sample.id|json_script:"init-id" }}

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // === 1. 初始化 ===
        const COLOR_MAP = {}; const LABEL_MAP_CN = {}; const LABEL_MAP_EN = {};
        {% for item in label_config %}
            COLOR_MAP['{{ item.code }}'] = '{{ item.color }}';
            LABEL_MAP_CN['{{ item.code }}'] = '{{ item.name_cn }}';
            LABEL_MAP_EN['{{ item.code }}'] = '{{ item.name_en }}';
        {% endfor %}
        if(!Object.keys(COLOR_MAP).length) COLOR_MAP['nodule'] = '#e74c3c';

        const state = { 
            currentTool: 'select', 
            isDrawing: false, isConfirming: false, isDragging: false, 
            dragTargetIdx: -1, lastMouse: null, rectStart: null,
            points: [], annotations: [], 
            scale: 1, mouse: {x: 0, y: 0}, lang: 'cn', hasUnsavedChanges: false 
        };

        const currentSample = { id: null, nextId: null, prevId: null };
        const canvas = document.getElementById('annotation-layer');
        const ctx = canvas.getContext('2d');
        const img = document.getElementById('target-image');

        // === 2. 状态管理 ===
        function markAsDirty() {
            state.hasUnsavedChanges = true;
            $('#save-status').removeClass('status-saved').addClass('status-unsaved');
            $('#save-text').text('未保存');
        }
        function markAsSaved() {
            state.hasUnsavedChanges = false;
            $('#save-status').removeClass('status-unsaved').addClass('status-saved');
            $('#save-text').text('已保存');
        }

        function performSave(callback) {
            if (!state.hasUnsavedChanges) { if (callback) callback(); return; }
            $('#save-text').text('保存中...');
            $.ajax({
                url: "/labeler/api/save/" + currentSample.id + "/",
                type: "POST",
                data: JSON.stringify({ annotations: state.annotations }),
                contentType: "application/json",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                success: function(res) {
                    if(res.status === 'ok') { markAsSaved(); if (callback) callback(); }
                }
            });
        }

        // === 3. 加载逻辑 ===
        function loadSample(id) {
            if (!id) return;
            const executeLoad = () => {
                $('#loading-overlay').show();
                $('#img-wrapper').css('visibility', 'hidden');
                $('#btn-prev, #btn-next').prop('disabled', true);

                $.ajax({
                    url: "{% url 'labeler:annotate' 0 %}".replace('0', id) + "?ajax=1",
                    type: "GET",
                    success: function(res) {
                        if (res.status === 'ok') {
                            currentSample.id = res.sample.id;
                            currentSample.nextId = res.next_id;
                            currentSample.prevId = res.prev_id;
                            state.annotations = res.sample.annotations;
                            
                            // 重置
                            state.points = []; state.isDrawing = false; state.isConfirming = false; 
                            state.isDragging = false; state.dragTargetIdx = -1; state.rectStart = null;
                            markAsSaved();
                            $('#label-modal').hide();
                            
                            // 更新UI
                            $('#img-name-display').text(res.sample.name);
                            $('#btn-prev').prop('disabled', !res.prev_id);
                            $('#btn-next').prop('disabled', !res.next_id);
                            history.pushState(null, '', "{% url 'labeler:annotate' 0 %}".replace('0', id));

                            img.src = res.sample.url;
                            img.onload = function() {
                                $('#loading-overlay').fadeOut(200);
                                $('#img-wrapper').css('visibility', 'visible').hide().fadeIn(200);
                                initCanvas();
                                if (res.next_id) preloadNext(res.next_id);
                            };
                            updateSidebar();
                        }
                    }
                });
            };

            if (state.hasUnsavedChanges) performSave(executeLoad);
            else executeLoad();
        }

        function preloadNext(nextId) {
            $.get("{% url 'labeler:annotate' 0 %}".replace('0', nextId) + "?ajax=1", function(res){
                if(res.status === 'ok') { const i = new Image(); i.src = res.sample.url; }
            });
        }

        // === 4. 画布交互 ===
        function switchTool(tool) {
            if(state.isDrawing || state.isConfirming) return;
            state.currentTool = tool;
            $('.tool-btn').removeClass('active'); $('#tool-'+tool).addClass('active');
            canvas.style.cursor = (tool === 'select') ? 'default' : 'crosshair';
            render();
        }

        function initCanvas() {
            const w = $(img).width(), h = $(img).height();
            if(w===0 || h===0) return;
            canvas.width = w; canvas.height = h;
            state.scale = img.naturalWidth / w;
            render();
        }
        $(window).on('resize', initCanvas);

        function getRealCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: (e.clientX - rect.left) * state.scale, y: (e.clientY - rect.top) * state.scale };
        }

        function pointInPolygon(p, vs) {
            let inside = false;
            for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                if (((vs[i].y > p.y) !== (vs[j].y > p.y)) && (p.x < (vs[j].x - vs[i].x) * (p.y - vs[i].y) / (vs[j].y - vs[i].y) + vs[i].x)) inside = !inside;
            }
            return inside;
        }

        // --- 鼠标事件 ---
        $(canvas).on('mousedown', function(e) {
            if(e.button === 2) { undoPoint(); return; }
            if(state.isConfirming) return;
            
            const pos = getRealCoordinates(e);

            if (state.currentTool === 'select') {
                for (let i = state.annotations.length - 1; i >= 0; i--) {
                    if (pointInPolygon(pos, state.annotations[i].points)) {
                        state.isDragging = true; state.dragTargetIdx = i; state.lastMouse = pos;
                        render(); return;
                    }
                }
                return;
            }
            
            if (state.currentTool === 'rect') {
                state.isDrawing = true; state.rectStart = pos; state.points = [pos, pos, pos, pos];
            } else if (state.currentTool === 'polygon') {
                if (!state.isDrawing) { state.isDrawing = true; state.points = [pos]; }
                else {
                    if (state.points.length >= 3 && Math.hypot(pos.x-state.points[0].x, pos.y-state.points[0].y) < 15*state.scale) {
                        finishShape(); return;
                    }
                    state.points.push(pos);
                }
            }
            render();
        });

        $(canvas).on('mousemove', function(e) {
            if(state.isConfirming) return;
            state.mouse = getRealCoordinates(e);

            if (state.currentTool === 'select' && state.isDragging) {
                const dx = state.mouse.x - state.lastMouse.x, dy = state.mouse.y - state.lastMouse.y;
                state.annotations[state.dragTargetIdx].points.forEach(p => { p.x += dx; p.y += dy; });
                state.lastMouse = state.mouse;
                if(!state.hasUnsavedChanges) markAsDirty();
                render();
                return;
            }
            if (state.currentTool === 'select') {
                let h = state.annotations.some(a => pointInPolygon(state.mouse, a.points));
                canvas.style.cursor = h ? 'move' : 'default';
            }

            if (state.isDrawing) {
                if (state.currentTool === 'rect' && state.rectStart) {
                    const s = state.rectStart, c = state.mouse;
                    state.points = [{x:s.x, y:s.y}, {x:c.x, y:s.y}, {x:c.x, y:c.y}, {x:s.x, y:c.y}];
                } else if (state.currentTool === 'polygon' && state.points.length >= 3) {
                    const d = Math.hypot(state.mouse.x - state.points[0].x, state.mouse.y - state.points[0].y);
                    canvas.style.cursor = (d < 15 * state.scale) ? 'pointer' : 'crosshair';
                }
                render();
            }
        });

        $(canvas).on('mouseup', function() {
            if (state.currentTool === 'select' && state.isDragging) {
                state.isDragging = false; state.dragTargetIdx = -1;
            }
            if (state.currentTool === 'rect' && state.isDrawing) {
                const w = Math.abs(state.points[0].x - state.points[2].x);
                if (w < 5 * state.scale) cancelShape(); else finishShape();
            }
        });

        $(canvas).on('dblclick', function(e) {
            e.preventDefault();
            if(state.currentTool === 'polygon' && state.isDrawing && state.points.length>=3) finishShape();
        });

        // === 5. 渲染 ===
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            state.annotations.forEach((anno, i) => {
                const isTarget = (state.currentTool === 'select' && i === state.dragTargetIdx);
                drawPath(anno.points, COLOR_MAP[anno.label]||'#ccc', true, i, isTarget);
            });
            
            if (state.isDrawing && state.points.length > 0) {
                if(state.currentTool === 'rect') drawPath(state.points, '#00ff00', true);
                else {
                    drawPath(state.points, '#00ff00', false);
                    const l = state.points[state.points.length-1];
                    ctx.beginPath(); ctx.moveTo(l.x/state.scale, l.y/state.scale);
                    ctx.lineTo(state.mouse.x/state.scale, state.mouse.y/state.scale);
                    ctx.strokeStyle='#00ff00'; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
                }
            }
        }

        function drawPath(points, color, closed, index=null, isHighlight=false) {
            if(!points.length) return;
            ctx.beginPath(); ctx.moveTo(points[0].x/state.scale, points[0].y/state.scale);
            points.forEach(p => ctx.lineTo(p.x/state.scale, p.y/state.scale));
            if(closed) { ctx.closePath(); ctx.fillStyle = hexToRgba(color, 0.2); ctx.fill(); }
            ctx.strokeStyle = isHighlight ? '#fff' : color; 
            ctx.lineWidth = isHighlight ? 3 : 2; 
            ctx.stroke();

            // 绘制顶点
            if((state.currentTool !== 'select' || isHighlight) && !state.isDragging) {
                ctx.fillStyle = '#fff'; 
                points.forEach(p => { ctx.beginPath(); ctx.arc(p.x/state.scale, p.y/state.scale, 3, 0, Math.PI*2); ctx.fill(); });
            }

            // ✅ [修改1] 仅绘制索引数字，不再绘制中文名称 (去除文字干扰)
            if(index !== null) {
                const center = getCenter(points);
                ctx.fillStyle = "white"; ctx.font = "bold 12px Arial"; 
                ctx.strokeStyle = "black"; ctx.lineWidth = 2;
                // 只显示 #1, #2...
                const text = `#${index+1}`;
                ctx.strokeText(text, center.x/state.scale, center.y/state.scale);
                ctx.fillText(text, center.x/state.scale, center.y/state.scale);
            }
        }

        // === 6. 完成逻辑 (弹窗与取消) ===
        function finishShape() {
            state.isConfirming = true; state.isDrawing = true; render();
            let mx = state.mouse.x/state.scale + 20, my = state.mouse.y/state.scale;
            if (mx + 220 > $(window).width()) mx -= 240;
            if (my + 100 > $(window).height()) my -= 120;
            $('#label-modal').css({left: mx, top: my}).fadeIn(100);
            $('#label-select').focus();
        }

        window.confirmShape = function() {
            state.annotations.push({ points: [...state.points], label: $('#label-select').val() });
            state.isDrawing = false; state.isConfirming = false; state.points = []; state.rectStart = null;
            $('#label-modal').hide();
            updateSidebar(); markAsDirty();
        };

        // ✅ [修改3] 仅关闭弹窗，不删除图形 (返回编辑模式)
        window.dismissModal = function() {
            $('#label-modal').hide();
            state.isConfirming = false; 
            // 此时 state.isDrawing 仍然是 true，用户可以继续调整
            // 比如多边形可以继续加点，矩形可以重新拖拽
            render();
        };

        // 完全丢弃图形 (按ESC触发)
        window.cancelShape = function() {
            state.isDrawing = false; state.isConfirming = false; state.points = []; state.rectStart = null;
            $('#label-modal').hide(); render();
        };

        window.undoPoint = function() {
            if (state.currentTool === 'polygon' && state.points.length > 0) {
                state.points.pop(); if (!state.points.length) cancelShape(); render();
            }
        };

        window.removeAnno = function(idx) { 
            state.annotations.splice(idx, 1); updateSidebar(); markAsDirty(); 
        };

        function updateSidebar() {
            const $list = $('#list-container').empty();
            state.annotations.forEach((anno, i) => {
                let name = (state.lang === 'cn' ? LABEL_MAP_CN[anno.label] : LABEL_MAP_EN[anno.label]) || anno.label;
                $list.append(`<div class="anno-item" style="border-left-color:${COLOR_MAP[anno.label]}"><span>${i+1}. ${name}</span><i class="fa fa-trash" onclick="removeAnno(${i})"></i></div>`);
            });
            render();
        }

        // 辅助
        function getCenter(pts) { let x=0,y=0; pts.forEach(p=>{x+=p.x;y+=p.y}); return {x:x/pts.length, y:y/pts.length}; }
        function hexToRgba(hex, a) { const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }
        
        // 快捷键
        $(document).keydown(function(e) {
            if ($('input, select').is(':focus')) return;
            const key = e.key.toLowerCase();
            if ((e.ctrlKey || e.metaKey) && key === 's') { e.preventDefault(); performSave(); return; }
            
            if (key === 'v') switchTool('select'); if (key === 'r') switchTool('rect'); if (key === 'p') switchTool('polygon');
            if (key === 'a') loadSample(currentSample.prevId); if (key === 'd') loadSample(currentSample.nextId);
            
            if (e.key === 'Enter') { if(state.isConfirming) confirmShape(); else if(state.currentTool==='polygon') finishShape(); }
            
            // ✅ ESC 直接丢弃
            if (e.key === 'Escape') cancelShape(); 
            if ((e.ctrlKey || e.metaKey) && key === 'z') { e.preventDefault(); undoPoint(); }
        });
        
        $(canvas).on('contextmenu', () => false);
        $('#lang-switch').change(function() { state.lang = $(this).val(); updateSidebar(); });
        window.onbeforeunload = function() { if (state.hasUnsavedChanges) return "未保存，确定离开？"; };

        const initId = JSON.parse(document.getElementById('init-id').textContent);
        if(initId) loadSample(initId);
    </script>
</body>
</html>